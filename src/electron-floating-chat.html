<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIåŠ©æ‰‹</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: transparent;
      height: 100vh;
      overflow: hidden;
      margin: 0;
      padding: 0;
    }
    
    .electron-floating-chat-container {
      position: fixed;
      z-index: 9999;
      user-select: none;
      width: 100vw;
      height: 100vh;
      top: 0;
      left: 0;
      padding: 10px;
      box-sizing: border-box;
    }
    
    .electron-floating-chat-container.fullscreen {
      position: fixed !important;
      top: 2.5vh !important;
      left: 2.5vw !important;
      width: 95vw !important;
      height: 95vh !important;
      z-index: 10001 !important;
      transform: none !important;
      margin: 0 !important;
      padding: 0 !important;
    }
    
    .electron-floating-chat-container.pinned {
      z-index: 99999 !important;
      position: fixed !important;
    }
    
    .electron-floating-chat-window {
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      width: 400px;
      height: 850px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: all 0.3s ease;
      border: 1px solid #e5e7eb;
      margin: 10px;
      position: relative;
    }
    
    .electron-floating-chat-window.fullscreen {
      width: 100% !important;
      height: 100% !important;
      position: relative !important;
      top: 0 !important;
      left: 0 !important;
      transform: none !important;
      z-index: 1 !important;
      border-radius: 12px !important;
      margin: 0 !important;
    }
    
    .electron-floating-chat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      cursor: move;
      user-select: none;
      background: #f8fafc;
      border-bottom: 1px solid #e5e7eb;
      -webkit-app-region: drag;
      position: relative;
    }
    
    .agent-name {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      font-weight: 700;
      color: #374151;
      font-size: 16px;
      -webkit-app-region: drag;
      pointer-events: auto;
      z-index: 10;
    }
    
    .pin-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      color: #6b7280;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      -webkit-app-region: no-drag;
    }
    
    .pin-btn:hover {
      background: #f3f4f6;
      color: #374151;
      transform: scale(1.1);
    }
    
    .pin-btn.pinned {
      color: #3b82f6;
      background: #eff6ff;
    }
    
    .pin-btn.pinned:hover {
      background: #dbeafe;
      color: #1d4ed8;
    }
    
    .electron-floating-chat-actions {
      display: flex;
      gap: 8px;
    }
    
    .action-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      color: #6b7280;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      -webkit-app-region: no-drag;
    }
    
    .action-btn:hover {
      background: #f3f4f6;
      color: #374151;
    }
    
    .electron-floating-chat-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px 24px;
      scrollbar-width: none;
      -ms-overflow-style: none;
      min-height: 0;
      max-height: calc(100% - 120px);
    }
    
    .electron-floating-chat-content::-webkit-scrollbar {
      display: none;
    }
    
    .electron-floating-chat-empty {
      text-align: center;
      padding: 40px 20px;
    }
    
    .empty-illustration {
      margin-bottom: 24px;
    }
    
    .hexagon-shape {
      width: 120px;
      height: 120px;
      margin: 0 auto;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }
    
    .illustration-icon {
      font-size: 48px;
      color: white;
      z-index: 1;
    }
    
    .empty-message {
      font-size: 16px;
      color: #374151;
      margin: 0 0 24px;
      font-weight: 500;
    }
    
    .hot-searches {
      background: #f9fafb;
      border-radius: 8px;
      padding: 16px;
      text-align: left;
    }
    
    .hot-searches-title {
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      margin: 0 0 12px;
    }
    
    .hot-searches-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .hot-tag {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 12px;
      color: #374151;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .hot-tag:hover {
      background: #f3f4f6;
      border-color: #d1d5db;
    }
    
    .electron-floating-chat-messages {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .electron-floating-message-item {
      display: flex;
      width: 100%;
    }
    
    .electron-floating-user-message {
      justify-content: flex-end;
    }
    
    .electron-floating-ai-message {
      justify-content: flex-start;
    }
    
    .electron-floating-message-bubble {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .user-bubble {
      background: #f3f4f6;
      color: #374151;
    }
    
    .ai-bubble {
      background: white;
      border: 1px solid #e5e7eb;
      color: #374151;
    }
    
    .electron-floating-message-text {
      font-size: 14px;
      line-height: 1.5;
      word-wrap: break-word;
    }
    
    .electron-floating-message-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #f3f4f6;
      flex-wrap: wrap;
    }
    
    .electron-floating-stats-info {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #6b7280;
      flex: 1;
      min-width: 0;
    }
    
    .electron-floating-stat-item {
      font-size: 12px;
      color: #6b7280;
    }
    
    .electron-floating-stat-separator {
      font-size: 12px;
      color: #d1d5db;
    }
    
    .electron-floating-action-buttons {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-shrink: 0;
    }
    
    .electron-floating-action-btn {
      width: 24px;
      height: 24px;
      border: none;
      background: transparent;
      color: #9ca3af;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 12px;
    }
    
    .electron-floating-action-btn:hover {
      background: #f3f4f6;
      color: #6b7280;
    }
    
    .electron-floating-loading-container {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 0;
    }
    
    .electron-floating-loading-dots {
      display: flex;
      gap: 4px;
    }
    
    .electron-floating-dot {
      width: 6px;
      height: 6px;
      background-color: #9ca3af;
      border-radius: 50%;
      animation: electron-floating-bounce 1.4s infinite ease-in-out both;
    }
    
    .electron-floating-dot:nth-child(1) { animation-delay: -0.32s; }
    .electron-floating-dot:nth-child(2) { animation-delay: -0.16s; }
    .electron-floating-dot:nth-child(3) { animation-delay: 0s; }
    
    @keyframes electron-floating-bounce {
      0%, 80%, 100% {
        transform: scale(0);
        opacity: 0.5;
      }
      40% {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    .electron-floating-loading-text {
      color: #6b7280;
      font-size: 14px;
      font-style: italic;
    }
    
    .input-container {
      padding: 20px;
      background: white;
      flex-shrink: 0;
    }
    
    .uploaded-files-floating {
      position: absolute;
      bottom: 150px;
      left: 20px;
      right: 20px;
      z-index: 1000;
      pointer-events: none;
    }
    
    .uploaded-files-floating .file-item {
      pointer-events: auto;
      opacity: 0.3;
      transition: opacity 0.3s ease;
    }
    
    .uploaded-files-floating.file-hovered .file-item {
      opacity: 1;
      transition: opacity 0.2s ease;
    }
    
    .file-item {
      display: inline-block;
      margin-right: 8px;
      position: relative;
    }
    
    /* å›¾ç‰‡é¢„è§ˆæ ·å¼ */
    .file-item img {
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      width: 64px;
      height: 64px;
      object-fit: cover;
      transition: transform 0.2s ease;
    }
    
    .file-item:hover img {
      transform: scale(1.05);
    }
    
    /* æ–‡ä»¶å¡ç‰‡æ ·å¼ */
    .file-card {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 12px 12px 8px;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(4px);
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      min-width: 0;
      max-width: 200px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    
    .file-icon {
      flex-shrink: 0;
      font-size: 18px;
      color: #6b7280;
      margin-left: 0px;
      margin-right: 4px;
    }
    
    .file-info {
      flex: 1;
      min-width: 0;
      max-width: 120px;
    }
    
    .file-name {
      font-weight: 500;
      font-size: 14px;
      color: #111827;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 140px;
    }
    
    .file-size {
      font-size: 12px;
      color: #6b7280;
    }
    
    .file-remove-btn {
      position: absolute;
      top: -4px;
      right: -4px;
      width: 16px;
      height: 16px;
      background: #4b5563;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      opacity: 0;
    }
    
    .file-item:hover .file-remove-btn {
      opacity: 1;
    }
    
    .file-remove-btn:hover {
      background: #ef4444;
    }
    
    /* è¾“å…¥æ¡†å®¹å™¨æ ·å¼ */
    .input-wrapper {
      background: white;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      padding: 8px;
    }
    
    .input-textarea {
      width: 100%;
      background: transparent;
      border: none;
      outline: none;
      color: #374151;
      font-size: 14px;
      resize: none;
      font-family: inherit;
      line-height: 1.5;
    }
    
    .input-textarea::placeholder {
      color: #9ca3af;
    }
    
    .input-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-top: 4px;
    }
    
    .input-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .upload-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      color: #9ca3af;
      background: transparent;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
    }
    
    .upload-btn:hover {
      color: #2563eb;
      background: #eff6ff;
    }
    
    .upload-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .upload-btn:disabled:hover {
      color: #9ca3af;
      background: transparent;
    }
    
    .input-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .input-length {
      font-size: 12px;
      color: #9ca3af;
    }
    
    .send-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
    }
    
    .send-btn:hover {
      background: #1d4ed8;
    }
    
    .send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .cancel-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: #dc2626;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
    }
    
    .cancel-btn:hover {
      background: #b91c1c;
    }
    
    /* éšè— textarea çš„æ»šåŠ¨æ¡ */
    textarea {
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE and Edge */
    }
    
    textarea::-webkit-scrollbar {
      display: none; /* Chrome, Safari, Opera */
    }
    
    /* ç¡®ä¿flexå¸ƒå±€æ­£å¸¸å·¥ä½œ */
    .input-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .input-actions {
      display: flex;
      align-items: center;
    }
    
    .input-info {
      display: flex;
      align-items: center;
    }
    
    /* æ–‡ä»¶åˆ—è¡¨å®¹å™¨ */
    .files-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    /* ç¡®ä¿æŒ‰é’®å›¾æ ‡å±…ä¸­ */
    .upload-btn i,
    .send-btn i,
    .cancel-btn i {
      font-size: 14px;
    }
    
    /* æ–‡ä»¶å¡ç‰‡å¸ƒå±€ */
    .file-card {
      display: flex;
      align-items: center;
    }
    
    /* ç¡®ä¿åˆ é™¤æŒ‰é’®åœ¨æ­£ç¡®ä½ç½® */
    .file-item {
      position: relative;
    }
    
    .file-item .file-remove-btn {
      position: absolute;
      top: -4px;
      right: -4px;
    }
    
    /* Markdown æ ·å¼ */
    .electron-floating-message-text h1,
    .electron-floating-message-text h2,
    .electron-floating-message-text h3,
    .electron-floating-message-text h4,
    .electron-floating-message-text h5,
    .electron-floating-message-text h6 {
      margin: 0.5em 0;
      font-weight: bold;
      line-height: 1.2;
    }
    
    .electron-floating-message-text h1 { font-size: 1.3em; }
    .electron-floating-message-text h2 { font-size: 1.2em; }
    .electron-floating-message-text h3 { font-size: 1.1em; }
    
    .electron-floating-message-text p {
      margin: 0.5em 0;
      line-height: 1.5;
    }
    
    .electron-floating-message-text ul,
    .electron-floating-message-text ol {
      margin: 0.5em 0;
      padding-left: 1.5em;
    }
    
    .electron-floating-message-text li {
      margin: 0.25em 0;
    }
    
    .electron-floating-message-text blockquote {
      margin: 0.5em 0;
      padding: 0.5em 1em;
      border-left: 4px solid #e5e7eb;
      background-color: #f9fafb;
      font-style: italic;
    }
    
    .electron-floating-message-text code {
      background-color: #f3f4f6;
      padding: 0.2em 0.4em;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
    }
    
    .electron-floating-message-text pre {
      background-color: #f3f4f6;
      padding: 1em;
      border-radius: 6px;
      overflow-x: auto;
      margin: 0.5em 0;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    
    .electron-floating-message-text pre::-webkit-scrollbar {
      display: none;
    }
    
    .electron-floating-message-text pre code {
      background: none;
      padding: 0;
    }
    
    .electron-floating-message-text a {
      color: #3b82f6;
      text-decoration: underline;
    }
    
    .electron-floating-message-text a:hover {
      color: #1d4ed8;
    }
    
    .electron-floating-message-text strong {
      font-weight: bold;
    }
    
    .electron-floating-message-text em {
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="electron-floating-chat-container" id="chatContainer">
    <div class="electron-floating-chat-window" id="chatWindow">
      <!-- å¤´éƒ¨ -->
      <div class="electron-floating-chat-header" id="chatHeader">
        <button class="pin-btn" id="pinBtn" title="ç½®é¡¶çª—å£">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 2l-1.5 1.5L12 5l1.5-1.5L12 2z"/>
            <path d="M12 5v13"/>
            <circle cx="12" cy="20" r="2"/>
          </svg>
        </button>
        <div class="agent-name" id="agentName">AIåŠ©æ‰‹</div>
        <div class="electron-floating-chat-actions">
          <button class="action-btn" id="fullscreenBtn" title="å…¨å±">
            <i class="fas fa-expand"></i>
          </button>
          <button class="action-btn" id="closeBtn" title="å…³é—­">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>

      <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
      <div class="electron-floating-chat-content" id="chatContent">
        <!-- ç©ºçŠ¶æ€ -->
        <div id="emptyState" class="electron-floating-chat-empty">
          <div class="empty-illustration">
            <div class="hexagon-shape">
              <i class="fas fa-comments illustration-icon"></i>
            </div>
          </div>
          <p class="empty-message">å³åˆ»å¼€å¯AIå¯¹è¯</p>
          
          <!-- çƒ­é—¨é—®é¢˜ -->
          <div class="hot-searches">
            <h4 class="hot-searches-title">çƒ­é—¨é—®é¢˜</h4>
            <div class="hot-searches-tags">
              <span class="hot-tag">å¦‚ä½•ä½¿ç”¨AIåŠ©æ‰‹ï¼Ÿ</span>
              <span class="hot-tag">æ¨¡å‹è°ƒç”¨æ–¹æ³•</span>
              <span class="hot-tag">APIæ¥å£è¯´æ˜</span>
              <span class="hot-tag">æ™ºèƒ½ä½“é…ç½®</span>
            </div>
          </div>
        </div>

        <!-- å¯¹è¯åˆ—è¡¨ -->
        <div id="messagesContainer" class="electron-floating-chat-messages" style="display: none;">
        </div>
      </div>

      <!-- å·²ä¸Šä¼ æ–‡ä»¶å±•ç¤ºåŒºåŸŸ - æ‚¬æµ®æ˜¾ç¤º -->
      <div id="uploadedFiles" class="uploaded-files-floating" style="display: none;">
        <div class="flex flex-wrap gap-2">
          <div id="filesList" class="files-list"></div>
        </div>
      </div>

      <!-- è¾“å…¥æ¡†éƒ¨åˆ† -->
      <div class="input-container">
        <div class="input-wrapper">
          <textarea
            id="messageInput"
            class="input-textarea"
            placeholder="è¯·è¾“å…¥å†…å®¹..."
            rows="3"
          ></textarea>
          
          <!-- åº•éƒ¨æ“ä½œæ  -->
          <div class="input-footer">
            <!-- å·¦ä¾§æŒ‰é’® -->
            <div class="input-actions">
              <button
                id="imageUploadBtn"
                class="upload-btn"
                title="ä¸Šä¼ å›¾ç‰‡"
              >
                <i class="fas fa-image"></i>
              </button>
              <button
                id="fileUploadBtn"
                class="upload-btn"
                title="ä¸Šä¼ æ–‡ä»¶"
              >
                <i class="fas fa-file"></i>
              </button>
            </div>
            
            <!-- å³ä¾§ä¿¡æ¯ -->
            <div class="input-info">
              <span id="inputLength" class="input-length">0/129024</span>
              <button
                id="sendBtn"
                class="send-btn"
                title="å‘é€æ¶ˆæ¯"
              >
                <i class="fas fa-arrow-up"></i>
              </button>
              <button
                id="cancelBtn"
                class="cancel-btn"
                title="å–æ¶ˆå‘é€"
                style="display: none;"
              >
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ä»URLå‚æ•°è·å–agentIdå’ŒagentName
    const urlParams = new URLSearchParams(window.location.search);
    const agentId = urlParams.get('agentId') || null;
    const agentName = urlParams.get('agentName') || 'AIåŠ©æ‰‹';
    
    // æ™ºèƒ½ä½“é…ç½®ä¿¡æ¯
    let agentConfig = {
      agent_name: agentName,
      agent_state: "1",
      agent_id: agentId,
      llm_api: "",
      llm_prompt: "",
      llm_image: "n"
    };
    
    // çŠ¶æ€ç®¡ç†
    let messages = [];
    let isPinned = false;
    let isFullscreen = false;
    let isDragging = false;
    let dragStart = { x: 0, y: 0 };
    let position = { x: 100, y: 100 };
    let forceTopInterval = null;
    let uploadedFilesList = [];
    let isSending = false;
    let currentRequest = null;
    let fileHoverTimeout = null;
    let isFileHovered = false;
    
    // DOMå…ƒç´ 
    const chatContainer = document.getElementById('chatContainer');
    const chatWindow = document.getElementById('chatWindow');
    const chatHeader = document.getElementById('chatHeader');
    const pinBtn = document.getElementById('pinBtn');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const closeBtn = document.getElementById('closeBtn');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const chatContent = document.getElementById('chatContent');
    const emptyState = document.getElementById('emptyState');
    const messagesContainer = document.getElementById('messagesContainer');
    const agentNameElement = document.getElementById('agentName');
    const imageUploadBtn = document.getElementById('imageUploadBtn');
    const fileUploadBtn = document.getElementById('fileUploadBtn');
    const uploadedFiles = document.getElementById('uploadedFiles');
    const filesList = document.getElementById('filesList');
    const inputLength = document.getElementById('inputLength');
    const cancelBtn = document.getElementById('cancelBtn');
    
    // è®¾ç½®æ™ºèƒ½ä½“åç§°
    if (agentNameElement) {
      agentNameElement.textContent = agentName;
      console.log('è®¾ç½®æ™ºèƒ½ä½“åç§°:', agentName);
    }
    
    // è·å–æ™ºèƒ½ä½“é…ç½®ä¿¡æ¯
    async function loadAgentConfig() {
      if (!agentId) return;
      
      try {
        // ç¬¬ä¸€æ­¥ï¼šæ ¹æ®agent_idè·å–æ™ºèƒ½ä½“é…ç½®
        const response = await fetch(`http://localhost:5000/selectAgentById/${agentId}`);
        if (response.ok) {
          const data = await response.json();
          console.log('âœ… ç¬¬ä¸€æ­¥ï¼šè·å–æ™ºèƒ½ä½“é…ç½®æˆåŠŸ:', data);
          
          // æ„å»ºæ™ºèƒ½ä½“é…ç½®
          agentConfig = {
            agent_name: data.agent_name || agentName,
            agent_state: data.agent_state || "1",
            agent_id: agentId,
            llm_api: data.llm_api || "",
            llm_prompt: data.llm_prompt || "",
            llm_image: data.llm_image || "y",
            llm_file: data.llm_file || "y",
            llm_internet: data.llm_internet || "y",
            llm_memory: data.llm_memory || "y",
            llm_knowledge: data.llm_knowledge || "",
            llm_maximum_length_of_reply: data.llm_maximum_length_of_reply || "2048",
            llm_carry_number_of_rounds_of_context: data.llm_carry_number_of_rounds_of_context || "30",
            llm_temperature_coefficient: data.llm_temperature_coefficient || "0.6"
          };
          console.log('âœ… æ™ºèƒ½ä½“é…ç½®å·²æ„å»º:', agentConfig);
          
          // æ ¹æ®é…ç½®æ›´æ–°ä¸Šä¼ æŒ‰é’®æ˜¾éš
          updateUploadButtonsVisibility();
        } else {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
      } catch (error) {
        console.error('âŒ ç¬¬ä¸€æ­¥ï¼šåŠ è½½æ™ºèƒ½ä½“é…ç½®å¤±è´¥:', error);
        // ä½¿ç”¨é»˜è®¤é…ç½®
        agentConfig = {
          agent_name: agentName,
          agent_state: "1",
          agent_id: agentId,
          llm_api: "qwen-max",
          llm_prompt: "é»˜è®¤æ¨¡æ¿",
          llm_image: "y",
          llm_file: "y",
          llm_internet: "y",
          llm_memory: "y",
          llm_knowledge: "",
          llm_maximum_length_of_reply: "2048",
          llm_carry_number_of_rounds_of_context: "30",
          llm_temperature_coefficient: "0.6"
        };
        
        // æ ¹æ®é»˜è®¤é…ç½®æ›´æ–°ä¸Šä¼ æŒ‰é’®æ˜¾éš
        updateUploadButtonsVisibility();
      }
    }
    
    // åˆå§‹åŒ–
    async function init() {
      setupEventListeners();
      updateUI();
      setupElectronListeners();
      await loadAgentConfig();
      
      // ç¡®ä¿åˆå§‹çŠ¶æ€ä¸ç½®é¡¶
      if (window.require) {
        const { ipcRenderer } = window.require('electron');
        ipcRenderer.send('set-always-on-top', false);
        console.log('åˆå§‹åŒ–ï¼šè®¾ç½®çª—å£ä¸ç½®é¡¶');
      }
    }
    
    // æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
    function openImageUpload() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = handleImageSelect;
      input.click();
    }
    
    function openFileUpload() {
      const input = document.createElement('input');
      input.type = 'file';
      input.onchange = handleFileSelect;
      input.click();
    }
    
    function handleImageSelect(e) {
      const file = e.target.files[0];
      if (file) {
        addUploadedFile(file, 'image');
      }
    }
    
    function handleFileSelect(e) {
      const file = e.target.files[0];
      if (file) {
        addUploadedFile(file, 'file');
      }
    }
    
    function addUploadedFile(file, type) {
      const fileObj = {
        id: Date.now(),
        name: file.name,
        size: file.size,
        type: type,
        file: file,
        preview: null
      };
      
      // å¦‚æœæ˜¯å›¾ç‰‡ï¼Œç”Ÿæˆé¢„è§ˆ
      if (type === 'image') {
        const reader = new FileReader();
        reader.onload = (e) => {
          fileObj.preview = e.target.result;
          updateUploadedFilesDisplay();
        };
        reader.readAsDataURL(file);
      }
      
      uploadedFilesList.push(fileObj);
      updateUploadedFilesDisplay();
    }
    
    function removeUploadedFile(fileId) {
      uploadedFilesList = uploadedFilesList.filter(f => f.id !== fileId);
      updateUploadedFilesDisplay();
    }
    
    function clearAllFiles() {
      uploadedFilesList = [];
      updateUploadedFilesDisplay();
    }
    
    function updateUploadedFilesDisplay() {
      if (uploadedFilesList.length === 0) {
        uploadedFiles.style.display = 'none';
        return;
      }
      
      uploadedFiles.style.display = 'block';
      filesList.innerHTML = '';
      
      // æ·»åŠ æ‚¬åœäº‹ä»¶ç›‘å¬å™¨
      uploadedFiles.addEventListener('mouseenter', handleFileMouseEnter);
      uploadedFiles.addEventListener('mouseleave', handleFileMouseLeave);
      
      uploadedFilesList.forEach(file => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        
        if (file.type === 'image') {
          // å›¾ç‰‡æ–‡ä»¶ç›´æ¥å±•ç¤º
          fileItem.innerHTML = `
            <img 
              src="${file.preview || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0yMCAyMEg0NFY0NEgyMFYyMFoiIGZpbGw9IiM5Q0EzQUYiLz4KPC9zdmc+'}" 
              alt="preview"
            />
            <button 
              onclick="removeUploadedFile(${file.id})" 
              class="file-remove-btn"
            >
              Ã—
            </button>
          `;
        } else {
          // éå›¾ç‰‡æ–‡ä»¶æ˜¾ç¤ºå¡ç‰‡
          fileItem.innerHTML = `
            <div class="file-card">
              <div class="file-icon">
                <i class="fas fa-file"></i>
              </div>
              <div class="file-info">
                <div class="file-name">${file.name}</div>
                <div class="file-size">${formatFileSize(file.size)}</div>
              </div>
              <button 
                onclick="removeUploadedFile(${file.id})" 
                class="file-remove-btn"
              >
                Ã—
              </button>
            </div>
          `;
        }
        
        filesList.appendChild(fileItem);
      });
    }
    
    // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // æ–‡ä»¶æ‚¬åœå¤„ç†
    function handleFileMouseEnter() {
      // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
      if (fileHoverTimeout) {
        clearTimeout(fileHoverTimeout);
        fileHoverTimeout = null;
      }
      isFileHovered = true;
      uploadedFiles.classList.add('file-hovered');
    }
    
    function handleFileMouseLeave() {
      // è®¾ç½®å»¶è¿Ÿ1ç§’åé€æ˜åŒ–
      fileHoverTimeout = setTimeout(() => {
        isFileHovered = false;
        uploadedFiles.classList.remove('file-hovered');
      }, 1000);
    }
    
    // æ›´æ–°è¾“å…¥é•¿åº¦
    function updateInputLength() {
      const length = messageInput.value.length;
      inputLength.textContent = `${length}/129024`;
    }
    
    // å–æ¶ˆå‘é€
    function cancelSend() {
      if (currentRequest) {
        currentRequest.abort();
        currentRequest = null;
      }
      
      // ç«‹å³ç§»é™¤æ‰€æœ‰åŠ è½½çŠ¶æ€çš„æ¶ˆæ¯
      messages = messages.filter(message => !message.isLoading);
      
      // é‡ç½®å‘é€çŠ¶æ€
      isSending = false;
      sendBtn.style.display = 'flex';
      cancelBtn.style.display = 'none';
      sendBtn.innerHTML = '<i class="fas fa-arrow-up"></i>';
      sendBtn.title = 'å‘é€æ¶ˆæ¯';
      
      // æ›´æ–°UI
      updateUI();
      
      console.log('âœ… ç”¨æˆ·å–æ¶ˆäº†å‘é€è¯·æ±‚');
    }
    
    // æ ¹æ®agenté…ç½®æ§åˆ¶ä¸Šä¼ æŒ‰é’®æ˜¾éš
    function updateUploadButtonsVisibility() {
      if (!agentConfig) return;
      
      // æ ¹æ®llm_imageé…ç½®æ§åˆ¶å›¾ç‰‡ä¸Šä¼ æŒ‰é’®
      if (agentConfig.llm_image === 'y' || agentConfig.llm_image === 'Y') {
        imageUploadBtn.style.display = 'flex';
        imageUploadBtn.disabled = false;
        imageUploadBtn.classList.remove('disabled');
      } else {
        imageUploadBtn.style.display = 'flex';
        imageUploadBtn.disabled = true;
        imageUploadBtn.classList.add('disabled');
      }
      
      // æ ¹æ®llm_fileé…ç½®æ§åˆ¶æ–‡ä»¶ä¸Šä¼ æŒ‰é’®
      if (agentConfig.llm_file === 'y' || agentConfig.llm_file === 'Y') {
        fileUploadBtn.style.display = 'flex';
        fileUploadBtn.disabled = false;
        fileUploadBtn.classList.remove('disabled');
      } else {
        fileUploadBtn.style.display = 'flex';
        fileUploadBtn.disabled = true;
        fileUploadBtn.classList.add('disabled');
      }
      
      console.log('ğŸ“ ä¸Šä¼ æŒ‰é’®æ˜¾éšæ§åˆ¶:', {
        llm_image: agentConfig.llm_image,
        llm_file: agentConfig.llm_file,
        imageBtnEnabled: !imageUploadBtn.disabled,
        fileBtnEnabled: !fileUploadBtn.disabled
      });
    }
    
    // è®¾ç½®Electronäº‹ä»¶ç›‘å¬
    function setupElectronListeners() {
      if (window.require) {
        const { ipcRenderer } = window.require('electron');
        
        // ç›‘å¬å…¨å±çŠ¶æ€å˜åŒ–
        ipcRenderer.on('fullscreen-changed', (event, isFullscreen) => {
          console.log('æ”¶åˆ°å…¨å±çŠ¶æ€å˜åŒ–:', isFullscreen);
          isFullscreen = isFullscreen;
          updateFullscreenUI();
        });
      }
    }
    
    // æ›´æ–°å…¨å±UI
    function updateFullscreenUI() {
      if (isFullscreen) {
        fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
        fullscreenBtn.title = 'é€€å‡ºå…¨å±';
      } else {
        fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
        fullscreenBtn.title = 'å…¨å±';
      }
    }
    
    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
    function setupEventListeners() {
      // é˜²æ­¢é‡å¤ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
      if (window.eventListenersSetup) {
        return;
      }
      window.eventListenersSetup = true;
      
      // ç½®é¡¶æŒ‰é’®
      pinBtn.addEventListener('click', togglePin);
      
      // å…¨å±æŒ‰é’®
      fullscreenBtn.addEventListener('click', toggleFullscreen);
      
      // å…³é—­æŒ‰é’®
      closeBtn.addEventListener('click', closeWindow);
      
      // å‘é€æŒ‰é’®
      sendBtn.addEventListener('click', sendMessage);
      
      // æ–‡ä»¶ä¸Šä¼ æŒ‰é’®
      imageUploadBtn.addEventListener('click', openImageUpload);
      fileUploadBtn.addEventListener('click', openFileUpload);
      
      
      // æ‹–æ‹½åŠŸèƒ½ç”±CSSçš„-webkit-app-regionå¤„ç†
      
      // è¾“å…¥æ¡†äº‹ä»¶
      messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
      
      // è¾“å…¥é•¿åº¦ç›‘å¬
      messageInput.addEventListener('input', updateInputLength);
      
      // å–æ¶ˆæŒ‰é’®
      cancelBtn.addEventListener('click', cancelSend);
      
      // åˆå§‹åŒ–è¾“å…¥é•¿åº¦
      updateInputLength();
      
      
      // çƒ­é—¨é—®é¢˜ç‚¹å‡»
      document.querySelectorAll('.hot-tag').forEach(tag => {
        tag.addEventListener('click', () => {
          messageInput.value = tag.textContent;
          sendMessage();
        });
      });
    }
    
    // æ‹–æ‹½åŠŸèƒ½ç”±CSSçš„-webkit-app-regionå¤„ç†ï¼Œæ— éœ€JavaScript
    
    // åˆ‡æ¢ç½®é¡¶
    function togglePin() {
      isPinned = !isPinned;
      pinBtn.classList.toggle('pinned', isPinned);
      
      if (isPinned) {
        pinBtn.title = 'å–æ¶ˆç½®é¡¶';
        // ä½¿ç”¨Electron APIè®¾ç½®ç½®é¡¶
        if (window.require) {
          const { ipcRenderer } = window.require('electron');
          ipcRenderer.send('set-always-on-top', true);
        }
      } else {
        pinBtn.title = 'ç½®é¡¶çª—å£';
        // å–æ¶ˆç½®é¡¶
        if (window.require) {
          const { ipcRenderer } = window.require('electron');
          ipcRenderer.send('set-always-on-top', false);
        }
      }
      
      // çŸ­æš‚é—ªçƒæ•ˆæœæç¤ºç”¨æˆ·
      chatContainer.style.transform = 'scale(1.02)';
      chatContainer.style.transition = 'transform 0.15s ease';
      setTimeout(() => {
        chatContainer.style.transform = 'scale(1)';
        setTimeout(() => {
          chatContainer.style.transition = '';
        }, 150);
      }, 150);
    }
    
    // ç½®é¡¶åŠŸèƒ½å®ç°
    function enableForceTop() {
      // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
      if (forceTopInterval) {
        clearInterval(forceTopInterval);
      }
      
      // ç«‹å³è®¾ç½®ç½®é¡¶
      setForceTop();
      
      // æ¯100msæ£€æŸ¥ä¸€æ¬¡ï¼Œç¡®ä¿ç½®é¡¶
      forceTopInterval = setInterval(() => {
        setForceTop();
      }, 100);
      
      // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–
      document.addEventListener('visibilitychange', handleVisibilityChange);
      window.addEventListener('focus', handleWindowFocus);
    }
    
    function disableForceTop() {
      // æ¸…é™¤å®šæ—¶å™¨
      if (forceTopInterval) {
        clearInterval(forceTopInterval);
        forceTopInterval = null;
      }
      
      // ç§»é™¤äº‹ä»¶ç›‘å¬
      document.removeEventListener('visibilitychange', handleVisibilityChange);
      window.removeEventListener('focus', handleWindowFocus);
      
      // æ¢å¤é»˜è®¤z-index
      chatContainer.style.zIndex = '9999';
    }
    
    function setForceTop() {
      if (isPinned) {
        // ä½¿ç”¨æœ€å¤§z-indexå€¼
        chatContainer.style.zIndex = '2147483647';
        chatContainer.style.position = 'fixed';
        
        // ç¡®ä¿çª—å£å¯è§
        if (chatContainer.style.display === 'none') {
          chatContainer.style.display = 'block';
        }
      }
    }
    
    function handleVisibilityChange() {
      if (!document.hidden && isPinned) {
        setForceTop();
      }
    }
    
    function handleWindowFocus() {
      if (isPinned) {
        setForceTop();
      }
    }
    
    // åˆ‡æ¢å…¨å±
    function toggleFullscreen() {
      isFullscreen = !isFullscreen;
      
      if (window.require) {
        const { ipcRenderer } = window.require('electron');
        console.log('å‘é€å…¨å±åˆ‡æ¢è¯·æ±‚:', isFullscreen);
        ipcRenderer.send('toggle-fullscreen', isFullscreen);
        
        // åŒæ—¶ä½¿ç”¨CSSå…¨å±ä½œä¸ºå¤‡ç”¨
        if (isFullscreen) {
          chatContainer.classList.add('fullscreen');
          chatWindow.classList.add('fullscreen');
          // å¼ºåˆ¶é‡ç½®ä½ç½®ï¼Œé˜²æ­¢å¸é™„åˆ°åº•éƒ¨
          setTimeout(() => {
            forceResetFullscreenPosition();
          }, 50);
        } else {
          chatContainer.classList.remove('fullscreen');
          chatWindow.classList.remove('fullscreen');
          // é€€å‡ºå…¨å±æ—¶ä¹Ÿé‡ç½®ä½ç½®
          setTimeout(() => {
            forceResetFullscreenPosition();
          }, 50);
        }
      } else {
        // æµè§ˆå™¨ç¯å¢ƒ
        if (isFullscreen) {
          chatContainer.classList.add('fullscreen');
          chatWindow.classList.add('fullscreen');
          // å¼ºåˆ¶é‡ç½®ä½ç½®ï¼Œé˜²æ­¢å¸é™„åˆ°åº•éƒ¨
          setTimeout(() => {
            forceResetFullscreenPosition();
          }, 50);
        } else {
          chatContainer.classList.remove('fullscreen');
          chatWindow.classList.remove('fullscreen');
          // é€€å‡ºå…¨å±æ—¶ä¹Ÿé‡ç½®ä½ç½®
          setTimeout(() => {
            forceResetFullscreenPosition();
          }, 50);
        }
      }
      
      updateFullscreenUI();
    }
    
    // å¼ºåˆ¶é‡ç½®å…¨å±ä½ç½®
    function forceResetFullscreenPosition() {
      if (isFullscreen) {
        chatContainer.style.position = 'fixed';
        chatContainer.style.top = '2.5vh';
        chatContainer.style.left = '2.5vw';
        chatContainer.style.width = '95vw';
        chatContainer.style.height = '95vh';
        chatContainer.style.transform = 'none';
        chatContainer.style.margin = '0';
        chatContainer.style.padding = '0';
        console.log('å¼ºåˆ¶é‡ç½®å…¨å±ä½ç½®');
      } else {
        // é€€å‡ºå…¨å±æ—¶é‡ç½®ä¸ºé»˜è®¤æ ·å¼
        chatContainer.style.position = 'fixed';
        chatContainer.style.top = '0';
        chatContainer.style.left = '0';
        chatContainer.style.width = '100vw';
        chatContainer.style.height = '100vh';
        chatContainer.style.transform = 'none';
        chatContainer.style.margin = '0';
        chatContainer.style.padding = '0';
        console.log('é‡ç½®é€€å‡ºå…¨å±ä½ç½®');
      }
    }
    
    // å…³é—­çª—å£
    function closeWindow() {
      if (window.require) {
        const { ipcRenderer } = window.require('electron');
        // ç›´æ¥å…³é—­å½“å‰çª—å£
        const { remote } = window.require('electron');
        if (remote && remote.getCurrentWindow) {
          remote.getCurrentWindow().close();
        } else {
          // å¤‡ç”¨æ–¹æ³•ï¼šå‘é€å…³é—­è¯·æ±‚
          ipcRenderer.send('close-current-window');
        }
      } else {
        window.close();
      }
    }
    
    // å‘é€æ¶ˆæ¯
    async function sendMessage() {
      console.log('ğŸ” sendMessage è¢«è°ƒç”¨ï¼Œå½“å‰çŠ¶æ€:', { isSending, message: messageInput.value.trim() });
      
      const message = messageInput.value.trim();
      if (!message && uploadedFilesList.length === 0) return;
      
      if (isSending) {
        console.log('âš ï¸ æ­£åœ¨å‘é€ä¸­ï¼Œå¿½ç•¥é‡å¤è°ƒç”¨');
        return;
      }
      isSending = true;
      
      // æ›´æ–°å‘é€æŒ‰é’®çŠ¶æ€
      sendBtn.style.display = 'none';
      cancelBtn.style.display = 'flex';
      
      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
      if (message) {
        addMessage(message, false);
      }
      
      // æ¸…ç©ºè¾“å…¥æ¡†å’Œæ–‡ä»¶
      messageInput.value = '';
      clearAllFiles();
      
      // æ¸…ç©ºå­—æ•°ç»Ÿè®¡
      updateInputLength();
      
      // æ·»åŠ åŠ è½½çŠ¶æ€
      const loadingId = addLoadingMessage();
      
      // æ£€æŸ¥æ˜¯å¦æœ‰agentId
      if (!agentId) {
        console.error('agentId ä¸å­˜åœ¨');
        // ç§»é™¤åŠ è½½çŠ¶æ€
        removeLoadingMessage(loadingId);
        // é‡ç½®å‘é€çŠ¶æ€
        isSending = false;
        sendBtn.style.display = 'flex';
        cancelBtn.style.display = 'none';
        sendBtn.innerHTML = '<i class="fas fa-arrow-up"></i>';
        sendBtn.title = 'å‘é€æ¶ˆæ¯';
        return;
      }
      
      // ç¬¬äºŒæ­¥ï¼šä½¿ç”¨è·å–çš„é…ç½®å‘é€æ¶ˆæ¯
      try {
        // ç¡®ä¿æ™ºèƒ½ä½“é…ç½®å·²åŠ è½½
        if (!agentConfig.llm_api) {
          console.log('âš ï¸ æ™ºèƒ½ä½“é…ç½®æœªå®Œå…¨åŠ è½½ï¼Œé‡æ–°åŠ è½½...');
          await loadAgentConfig();
        }
        
        // æ„é€ è¯·æ±‚ä½“ï¼Œä½¿ç”¨å®Œæ•´çš„æ™ºèƒ½ä½“é…ç½®ä¿¡æ¯
        const payload = {
          ...agentConfig,
          message: message
        };
        
        console.log('âœ… ç¬¬äºŒæ­¥ï¼šå‘é€æ¶ˆæ¯è¯·æ±‚ä½“:', payload);
        
        // åˆ›å»ºAbortControllerç”¨äºå–æ¶ˆè¯·æ±‚
        const abortController = new AbortController();
        currentRequest = abortController;
        
        const response = await fetch(`http://localhost:5000/processAgent/${agentId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload),
          signal: abortController.signal
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('âœ… ç¬¬äºŒæ­¥ï¼šAPIå“åº”æˆåŠŸ:', data);
        
        // ç§»é™¤åŠ è½½çŠ¶æ€
        removeLoadingMessage(loadingId);
        
        // æ·»åŠ AIå›å¤
        if (data && data.result) {
          addMessage(data.result, true, data.stats);
          console.log('âœ… æ¶ˆæ¯å·²æ·»åŠ åˆ°èŠå¤©åˆ—è¡¨');
        } else {
          addMessage('æŠ±æ­‰ï¼ŒAIå›å¤å‡ºç°é”™è¯¯', true);
        }
        
      } catch (error) {
        // å¦‚æœæ˜¯ç”¨æˆ·ä¸»åŠ¨å–æ¶ˆï¼Œä¸æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼Œç›´æ¥è¿”å›
        if (error.name === 'AbortError') {
          console.log('âœ… ç”¨æˆ·å–æ¶ˆäº†å‘é€è¯·æ±‚');
          return;
        }
        
        console.error('âŒ ç¬¬äºŒæ­¥ï¼šå‘é€æ¶ˆæ¯å¤±è´¥:', error);
        removeLoadingMessage(loadingId);
        addMessage('æŠ±æ­‰ï¼Œè¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', true);
      } finally {
        // é‡ç½®å‘é€çŠ¶æ€ï¼ˆæ— è®ºæ˜¯å¦å–æ¶ˆéƒ½è¦é‡ç½®ï¼‰
        isSending = false;
        sendBtn.style.display = 'flex';
        cancelBtn.style.display = 'none';
        sendBtn.innerHTML = '<i class="fas fa-arrow-up"></i>';
        sendBtn.title = 'å‘é€æ¶ˆæ¯';
        currentRequest = null;
      }
    }
    
    
    // Markdown æ¸²æŸ“
    function renderMarkdown(content) {
      if (!content) return '';
      return marked.parse(content);
    }
    
    // æ·»åŠ æ¶ˆæ¯
    function addMessage(content, isAI, stats = null) {
      console.log('ğŸ“ æ·»åŠ æ¶ˆæ¯:', { content: content.substring(0, 50) + '...', isAI, messageCount: messages.length });
      const messageId = Date.now() + Math.random();
      const message = { id: messageId, content, isAI, stats };
      messages.push(message);
      
      updateUI();
    }
    
    // æ·»åŠ åŠ è½½æ¶ˆæ¯
    function addLoadingMessage() {
      const loadingId = Date.now() + Math.random();
      const loadingMessage = { 
        id: loadingId, 
        content: '', 
        isAI: true, 
        isLoading: true 
      };
      messages.push(loadingMessage);
      
      updateUI();
      return loadingId;
    }
    
    // ç§»é™¤åŠ è½½æ¶ˆæ¯
    function removeLoadingMessage(loadingId) {
      messages = messages.filter(msg => msg.id !== loadingId);
      updateUI();
    }
    
    // æ›´æ–°UI
    function updateUI() {
      // è®¾ç½®ç½®é¡¶æŒ‰é’®åˆå§‹çŠ¶æ€
      pinBtn.classList.remove('pinned');
      pinBtn.title = 'ç½®é¡¶çª—å£';
      
      // æ˜¾ç¤º/éšè—ç©ºçŠ¶æ€
      if (messages.length === 0) {
        emptyState.style.display = 'block';
        messagesContainer.style.display = 'none';
      } else {
        emptyState.style.display = 'none';
        messagesContainer.style.display = 'flex';
      }
      
      // æ¸²æŸ“æ¶ˆæ¯
      renderMessages();
    }
    
    // æ¸²æŸ“æ¶ˆæ¯
    function renderMessages() {
      messagesContainer.innerHTML = '';
      
      messages.forEach(message => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `electron-floating-message-item ${message.isAI ? 'electron-floating-ai-message' : 'electron-floating-user-message'}`;
        
        const bubbleDiv = document.createElement('div');
        bubbleDiv.className = `electron-floating-message-bubble ${message.isAI ? 'ai-bubble' : 'user-bubble'}`;
        
        if (message.isLoading) {
          bubbleDiv.innerHTML = `
            <div class="electron-floating-loading-container">
              <div class="electron-floating-loading-dots">
                <div class="electron-floating-dot"></div>
                <div class="electron-floating-dot"></div>
                <div class="electron-floating-dot"></div>
              </div>
              <span class="electron-floating-loading-text">AI æ­£åœ¨æ€è€ƒä¸­...</span>
            </div>
          `;
        } else {
          const textDiv = document.createElement('div');
          textDiv.className = 'electron-floating-message-text';
          textDiv.innerHTML = renderMarkdown(message.content);
          bubbleDiv.appendChild(textDiv);
          
          // å¦‚æœæ˜¯AIæ¶ˆæ¯ï¼Œæ·»åŠ ç»Ÿè®¡ä¿¡æ¯å’Œæ“ä½œæŒ‰é’®
          if (message.isAI) {
            const footerDiv = document.createElement('div');
            footerDiv.className = 'electron-floating-message-footer';
            
            // ç»Ÿè®¡ä¿¡æ¯
            const statsInfo = document.createElement('div');
            statsInfo.className = 'electron-floating-stats-info';
            statsInfo.innerHTML = `
              <span class="electron-floating-stat-item">å­—æ•°: ${message.content.length}</span>
              <span class="electron-floating-stat-separator">|</span>
              <span class="electron-floating-stat-item">è¾“å…¥token: ${message.stats ? message.stats.input_tokens || 0 : 0}</span>
              <span class="electron-floating-stat-separator">|</span>
              <span class="electron-floating-stat-item">è¾“å‡ºtoken: ${message.stats ? message.stats.output_tokens || 0 : 0}</span>
            `;
            
            // æ“ä½œæŒ‰é’®
            const actionButtons = document.createElement('div');
            actionButtons.className = 'electron-floating-action-buttons';
            
            // æ„å»ºæŒ‰é’®HTML
            let buttonsHTML = `
              <button class="electron-floating-action-btn" title="å¤åˆ¶" onclick="copyMessage(${message.id})">
                <i class="fas fa-copy"></i>
              </button>
            `;
            
            // åªæœ‰æœ€æ–°çš„AIæ¶ˆæ¯æ‰æ˜¾ç¤ºé‡æ–°ç”ŸæˆæŒ‰é’®
            if (isLatestAIMessage(message)) {
              buttonsHTML += `
                <button class="electron-floating-action-btn" title="é‡æ–°ç”Ÿæˆ" onclick="retryMessage(${JSON.stringify(message).replace(/"/g, '&quot;')})">
                  <i class="fas fa-redo"></i>
                </button>
              `;
            }
            
            buttonsHTML += `
              <button class="electron-floating-action-btn" title="è·å–æ™ºèƒ½ä½“ID" onclick="showAgentId()">
                <i class="fas fa-id-card"></i>
              </button>
            `;
            
            actionButtons.innerHTML = buttonsHTML;
            
            footerDiv.appendChild(statsInfo);
            footerDiv.appendChild(actionButtons);
            bubbleDiv.appendChild(footerDiv);
          }
        }
        
        messageDiv.appendChild(bubbleDiv);
        messagesContainer.appendChild(messageDiv);
      });
      
      // æ»šåŠ¨åˆ°åº•éƒ¨
      chatContent.scrollTop = chatContent.scrollHeight;
    }
    
    // å¤åˆ¶æ¶ˆæ¯
    function copyMessage(messageId) {
      const message = messages.find(m => m.id === messageId);
      if (message) {
        navigator.clipboard.writeText(message.content).then(() => {
          console.log('æ¶ˆæ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
          // å¯ä»¥æ·»åŠ ä¸€ä¸ªæç¤º
        }).catch(err => {
          console.error('å¤åˆ¶å¤±è´¥:', err);
        });
      }
    }
    
    // åˆ¤æ–­æ˜¯å¦ä¸ºæœ€æ–°çš„AIæ¶ˆæ¯
    function isLatestAIMessage(message) {
      // å¦‚æœä¸æ˜¯ AI æ¶ˆæ¯ï¼Œç›´æ¥è¿”å› false
      if (!message.isAI) return false;

      // è·å–æ‰€æœ‰ AI æ¶ˆæ¯ï¼Œå¹¶æŒ‰ id æ’åºï¼ˆid æ˜¯æ—¶é—´æˆ³ï¼‰
      const aiMessages = messages.filter(m => m.isAI);
      
      // æ‰¾åˆ°æœ€åä¸€æ¡ AI æ¶ˆæ¯
      const latestAIMessage = aiMessages.length > 0 ? aiMessages[aiMessages.length - 1] : null;

      // åˆ¤æ–­å½“å‰æ¶ˆæ¯æ˜¯å¦ä¸ºæœ€æ–°çš„ä¸€æ¡ AI æ¶ˆæ¯
      return message.id === latestAIMessage?.id;
    }
    
    // é‡æ–°ç”Ÿæˆæ¶ˆæ¯
    async function retryMessage(message) {
      if (!agentId) {
        console.error('agentId ä¸å­˜åœ¨');
        return;
      }

      // æ‰¾åˆ°å½“å‰ AI æ¶ˆæ¯çš„ç´¢å¼•
      const aiIndex = messages.findIndex(m => m.id === message.id);
      if (aiIndex === -1) return;

      // ç«‹å³æ’¤é”€å½“å‰AIå›å¤ï¼Œæ›¿æ¢ä¸ºåŠ è½½çŠ¶æ€
      const loadingMessageId = Date.now() + Math.random();
      messages[aiIndex] = {
        id: loadingMessageId,
        content: '',
        isAI: true,
        isLoading: true
      };
      updateUI();

      // æ‰¾åˆ°å¯¹åº”çš„ç”¨æˆ·æ¶ˆæ¯
      const userMessage = messages[aiIndex - 1];
      if (!userMessage || userMessage.isAI) {
        console.error('æ‰¾ä¸åˆ°å¯¹åº”çš„ç”¨æˆ·æ¶ˆæ¯');
        return;
      }

      // å–æ¶ˆå½“å‰è¯·æ±‚ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
      if (currentRequest) {
        currentRequest.abort();
      }

      // åˆ›å»ºæ–°çš„è¯·æ±‚æ§åˆ¶å™¨
      const abortController = new AbortController();
      currentRequest = abortController;

      try {
        // ç¡®ä¿æ™ºèƒ½ä½“é…ç½®å·²åŠ è½½
        if (!agentConfig.llm_api) {
          console.log('âš ï¸ æ™ºèƒ½ä½“é…ç½®æœªå®Œå…¨åŠ è½½ï¼Œé‡æ–°åŠ è½½...');
          await loadAgentConfig();
        }

        // æ„é€ è¯·æ±‚ä½“
        const payload = {
          ...agentConfig,
          message: userMessage.content
        };

        console.log('âœ… é‡æ–°ç”Ÿæˆè¯·æ±‚ä½“:', payload);

        const response = await fetch(`http://localhost:5000/processAgent/${agentId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload),
          signal: abortController.signal
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log('âœ… é‡æ–°ç”Ÿæˆè¯·æ±‚æˆåŠŸ:', data);


        // æ›¿æ¢åŠ è½½æ¶ˆæ¯ä¸ºæ–°çš„AIå›å¤
        if (data && data.result) {
          messages[aiIndex] = {
            id: loadingMessageId,
            content: data.result,
            isAI: true,
            stats: data.stats
          };
        } else {
          console.warn('è¿”å›æ•°æ®ä¸­ç¼ºå°‘ result å­—æ®µ');
          messages[aiIndex] = {
            id: loadingMessageId,
            content: 'æŠ±æ­‰ï¼Œé‡æ–°ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•',
            isAI: true
          };
        }
      } catch (error) {
        // å¦‚æœæ˜¯ç”¨æˆ·ä¸»åŠ¨å–æ¶ˆï¼Œä¸æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        if (error.name === 'AbortError') {
          console.log('ç”¨æˆ·å–æ¶ˆäº†é‡æ–°ç”Ÿæˆè¯·æ±‚');
          return;
        }
        
        console.error('âŒ é‡æ–°ç”Ÿæˆå¤±è´¥:', error);
        
        // æ›¿æ¢åŠ è½½æ¶ˆæ¯ä¸ºé”™è¯¯ä¿¡æ¯
        messages[aiIndex] = {
          id: loadingMessageId,
          content: 'æŠ±æ­‰ï¼Œé‡æ–°ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•',
          isAI: true
        };
      } finally {
        // é‡ç½®è¯·æ±‚çŠ¶æ€
        currentRequest = null;
        updateUI();
      }
    }
    
    // æ˜¾ç¤ºæ™ºèƒ½ä½“ID
    function showAgentId() {
      if (agentId) {
        alert(`æ™ºèƒ½ä½“ID: ${agentId}`);
      } else {
        alert('å½“å‰æ²¡æœ‰æ™ºèƒ½ä½“ID');
      }
    }
    
    // å¯åŠ¨åº”ç”¨
    init();
  </script>
</body>
</html>

